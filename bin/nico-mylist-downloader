#!/bin/bash

#
# 2017-06-02
# Author: Mizuki Urushida
#

# Requirements
#	youtube-dl
#		https://rg3.github.io/youtube-dl/
#	jq
#		https://stedolan.github.io/jq/

usage_exit() {
		echo "Usage: $0 [-u] [-l] URL" 1>&2
		exit 1
}

while getopts "u:l" OPT
do
	case $OPT in
		u)	# NicoNico Username
			username=${OPTARG}
			;;
		l)	# List
			FLAG_L=1
			;;
		\?)	usage_exit
			;;
	esac
done
shift $((OPTIND - 1))

if [[ -z $1 ]]; then
	echo Require one mylist URL
	exit 1
fi

# extract mylist's ID
mylist_id=${1##*/}
mylist_base_url="http://www.nicovideo.jp/mylist"

# list mylist elements
if [[ ! -z $FLAG_L ]]; then
	wget -q ${mylist_base_url}/${mylist_id} -O - | grep "Mylist.preload" | perl -pe "s/\s*Mylist\.preload\([0-9]*,\s(.*)\);/\1/" | jq -c '.[] | .item_data | .video_id = "http://www.nicovideo.jp/watch/" + .video_id | {title: .title, url: .video_id}'
	exit 0
fi

# when $username is not specified even though don't list
if [[ -z ${username} && -z $FLAG_L ]]; then
	echo Require username for downloading
	exit 1
fi

youtube-dl -u ${username} `wget -q ${mylist_base_url}/${mylist_id} -O - | grep "Mylist.preload" | perl -pe "s/\s*Mylist\.preload\([0-9]*,\s(.*)\);/\1/" | jq -r  '.[] | .item_data | .video_id = "http://www.nicovideo.jp/watch/" + .video_id | .video_id' | tr "\n" " "`
